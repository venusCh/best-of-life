<script>
$(function() {
  $('#agree-and-send').attr("disabled", "disabled");

  $('#gentleman-agreement').change(function () {
    if ($('#gentleman-agreement')[0].checked == true) {
      console.log("just checked!");
      $('#agree-and-send').removeAttr("disabled");      
    }
    else {
      console.log("not checked");
      $('#agree-and-send').attr("disabled", "disabled");
    }
  });
});
</script>

<% page_header "Start Conversation" %>

<% @giving = Giving.find_by_id(params[:subject]) %>

<%if params[:recipient].to_s != current_user.id.to_s %>
  <div class="panel panel-default">
    <div class="panel-heading">
      <div class="conversation">
        <div class="conversation-title"><%= @giving.name %></div>
        <div class="conversation-status">
          <% if !@giving.regive_count.nil? && @giving.regive_count > 0%>
            <span style="color: #578e12;font-style: italic;">
            <% if @giving.regive_count == 1 %>
              <!-- TODO: show this only if it's given to you -->
              Given to you!
            <% elsif @giving.regive_count == 2 %>
              Re-given once!
            <% elsif @giving.regive_count == 3 %>
              Re-given twice!
            <% elsif @giving.regive_count > 3 %>
              Re-given <%= @giving.regive_count-1 %> <%= "time".pluralize(@giving.regive_count-1)%>!
            <% end %>
            </span>
          <% else %>
            <i>Posted on </i>
            <% if @today == @giving.created_at.strftime("%m/%d/%Y") %>
              <%= @giving.created_at.strftime("%I:%M%p") %>
            <% else %>
              <%= @giving.created_at.strftime("%-d %b, %Y") %>
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="topic-box-image" style="float:right;width: 65px;">
        <%= link_to(image_tag(@giving.image.url(:thumb)), @giving) %>
      </div>
    </div>
    <% @recipient = User.find_by_id(params[:recipient]) %>
    <div style="display: inline-block;">
      <div class="round-image-50">
        <a href="/profiles/<%=@recipient.id%>">
          <%= image_tag(@recipient.avatar.url(:thumb)) %>
        </a>
      </div>
      <div class="user-details-mini">
        <div class="user_profile"><%=@recipient.name%></div>
        <div class="user-location">
          <% if !@recipient.zip.nil? %>
            <%= @recipient.zip.to_region %>
          <% end %>
        </div>
        <div class="user-reviews">
          <% @upvote = 0 %>
          <% @downvote = 0 %>
          <% @recipient.comments.each do |comment| %>
            <% if User.find_by_id(comment.commenter).voted_up_on? @recipient, vote_scope: 'user_rating' %>
              <% @upvote += 1 %>
            <% elsif User.find_by_id(comment.commenter).voted_down_on? @recipient, vote_scope: 'user_rating' %>
              <% @downvote += 1 %>
            <% end %>
          <% end %>
          <%= link_to "Reviews:", "/profiles/#{@recipient.id}" %>
          <% if @upvote + @downvote == 0 %>
            <span style="color: #808080">None</span>
          <% else %>
            <% if @upvote > 0 %>
              <span style="color: #247b0e;"><b><%= @upvote %> <i class="fa fa-smile-o" aria-hidden="true"></i></b></span> &nbsp; 
            <% end %>
            <% if @downvote > 0 %>
              <span style="color: #bf6a48;">&nbsp;<b><%= @downvote %> <i class="fa fa-frown-o" aria-hidden="true"></i></b></span> &nbsp; 
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <div style="display: inline-block;">
      <div style="display: inline-block;width: 54px;">
        <div class="user-stats-mini">
          <div><%= image_tag(image_url('gift-icon.jpg'), class: "mini-image") %></div>
          <div>&nbsp;<%=@recipient.givings.count%></div>
        </div>
      </div>
      <div style="display: inline-block;width: 54px;">
        <div class="user-stats-mini">
          <div><%= image_tag(image_url('regive-icon.jpg'), class: "mini-image") %></div>
          <!-- TODO: move to backend -->
          <% @regivenCount = Transfer.where(["to_id = ? and is_active = 'f'", @recipient.id]).count %>
          <% @overdueCount = Transfer.where(["to_id = ? and is_active = 't' and due_date > ?", @recipient.id, @today]).count %>
          <div>&nbsp;<%= @regivenCount %>/<%= @regivenCount + @overdueCount %></div>
        </div>
      </div>
    </div>
  </div>

  <%= form_tag messages_path, method: :post do %>
    <div class="input-group" style="margin-top: 8px;width: 100%;">
      <%= text_field_tag 'message[subject]', nil, type: 'hidden', class: 'form-control', value: params[:subject], required: true %>
      <%= text_area_tag 'message[body]', nil, rows: 3, class: 'input-new-message', style: "resize: none;", required: true,  placeholder: "Write your request...", autofocus: true %>
      <%= text_field_tag 'recipients', nil, type: 'hidden', value: [params[:recipient]] %>
    </div>

    <div style= "margin: 15px 0;"> 
    <label class="checkbox-text"><input type="checkbox" class="agreement" id="gentleman-agreement"> I agree to re-give this in 
      <% @wish = Giving.find_by_id(params[:subject]).wish %>
      <% if Giving.find_by_id(params[:subject]).wish == 10 %>
        <b> a month </b> 
      <% elsif @wish == 20 %>
        <b> 3 months </b> 
      <% elsif @wish == 30 %>
        <b> 6 months </b> 
      <% elsif @wish == 40 %>
        <b> 1 year </b> 
      <% elsif @wish == 50 %>
        <b> 2 years </b> 
      <% end %>
    as per your wishes! </label></div>

    <%= submit_tag 'Send', class: 'btn-primary', id: 'agree-and-send' %>
  <% end %>
<% else %>
  <div class="condition-toast">
    Interesting, but don't see the point in talking to yourself!
  </div>
  <span style="color: #3E89C1"><i class="fa fa-chevron-circle-left" aria-hidden="true"></i></span>
  <%= link_to "Back", givings_path %>
<% end %>