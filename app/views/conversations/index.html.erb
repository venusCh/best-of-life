<% page_header "Your Conversations" %>

<div style="margin-bottom: 10px">
	<div style="display: inline-block; font-size: 1.3em;">
		<% if @show_sentbox %>
			<%= link_to "Inbox", conversations_path(:group => @group_by_givings) %> 
			| <b><%= link_to "Sent", conversations_path(:sent => "true", :group => @group_by_givings) %></b>
		<% else %>
			<b><%= link_to "Inbox", conversations_path(:group => @group_by_givings) %> </b>
			| <%= link_to "Sent", conversations_path(:sent => "true", :group => @group_by_givings) %>
		<% end %>
	</div>
	<div style="display: inline-block; float:right">
		<i class="fa fa-list-ul" aria-hidden="true"></i> 
		<% if @show_aggregate %>
			<%= link_to "Time", conversations_path(:sent => @show_sentbox) %> | <b>Giving</b>
		<% else %>
			<b>Time</b> | <%= link_to "Giving", conversations_path(:group => "true", :sent => @show_sentbox) %>
		<% end %>
	</div>
</div>

<% if !@topic_convos.nil? %>
	<% if @topic_convos.count > 0 %>
		<h3><%= Giving.find_by_id(@topic_convos[0].subject).name %></h3>
	<% end %>
	<ul class="list-group">
	  <%= render partial: 'conversations/conversation', collection: @topic_convos %>
	</ul>
<% else %>
	<% if @show_aggregate == false %>
		<% if @conversations.count > 0 %>
			<ul class="list-group">
			  <%= render partial: 'conversations/conversation', collection: @conversations %>
			</ul>
		<% else %>
			<div class="condition-toast">
				You have no messages. 
			</div>
		<% end %>
		<%= will_paginate %>
	<% else %>
		<% @grouped_convos.each_pair do |subject, convos| %>
			<% @giving = Giving.find_by_id(subject) %>
			<% if !@giving.nil? %> 
				<% @unread_count = 0 %>
				<% convos.each do |convo| %>
					<% if convo.is_unread?(current_user) %>
						<% @unread_count += 1 %>
					<% end %>
				<% end %>

				<% if @unread_count > 0 %>
					<div class="topic-box unread">
				<% else %>
					<div class="topic-box read">
				<% end %>
					<div class="topic-box-image">
						<%= image_tag @giving.image.url(:thumb) %>
					</div>
					<div style="display:inline-block;">
						<div><%= @giving.name %></div>
						<div>
						<% if @unread_count > 0 %>
							<%= link_to topic_conversations_path(:topic_id => subject, :sent => @show_sentbox) do %>
								<span class="badge-givings"><%= @unread_count %></span> new <%= "request".pluralize(@unread_count) %>
							<% end %>
						<% else %>
							<%= link_to topic_conversations_path(:topic_id => subject, :sent => @show_sentbox) do %>
								<%= convos.count %> <%= "request".pluralize(convos.count)%>
							<% end %>
						<% end %>
						</div>
					</div>
				</div>
			<% end %>
		<% end %>
	<% end %>
<% end %>